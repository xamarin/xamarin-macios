# Job that downloads the change detection artifact and:
# * Uploads the results to VSDrops
# * Publishes results (as a comment) to GitHub

steps:

- template: ../common/checkout.yml

# Download the change detection artifact
- task: DownloadPipelineArtifact@2
  displayName: 'Download change detection artifacts'
  inputs:
    patterns: 'change-detection/change-detection.zip'
    allowFailedBuilds: true
    path: $(System.DefaultWorkingDirectory)/Artifacts

# Unzip the change detection artifact
- task: ExtractFiles@1
  displayName: 'Decompress change detection artifacts'
  inputs:
    archiveFilePatterns: '$(System.DefaultWorkingDirectory)/Artifacts/change-detection/change-detection.zip'
    destinationFolder: '$(System.DefaultWorkingDirectory)/change-detection'

# Upload the change detection results to vsdrops
- task: ms-vscs-artifact.build-tasks.artifactDropTask-1.artifactDropTask@0
  displayName: 'Publish change detection results to Artifact Services Drop'
  continueOnError: true # don't let any failures here stop us
  inputs:
    dropServiceURI: 'https://devdiv.artifacts.visualstudio.com/DefaultCollection'
    dropMetadataContainerName: 'DropMetadata-ChangeDetection'
    buildNumber: 'xamarin-macios/detected-changes/$(Build.BuildNumber)/$(Build.BuildId)'
    sourcePath: '$(System.DefaultWorkingDirectory)/change-detection/results/'
    detailedLog: true
    usePat: true

# Process the github comment and publish it
- pwsh: |
    Import-Module $Env:SYSTEM_DEFAULTWORKINGDIRECTORY\xamarin-macios\tools\devops\automation\scripts\MaciosCI.psd1
    $vsdropsChangeDetectionPrefix = "https://vsdrop.corp.microsoft.com/file/v1/xamarin-macios/detected-changes/$Env:BUILD_BUILDNUMBER/$Env:BUILD_BUILDID/;/"

    $rootDirectory = Join-Path "$Env:SYSTEM_DEFAULTWORKINGDIRECTORY" "change-detection" "results"

    $inputContentsPath = Join-Path -Path $rootDirectory -ChildPath "gh-comment.md"
    if (Test-Path $inputContentsPath -PathType leaf) {
      $inputContents = Get-Content -Path $inputContentsPath -Raw
    } else {
      $inputContents = ":fire: Unable to find the contents for the comment: $inputContentsPath does not exist :fire"
    }

    try {
      $converted = Convert-Markdown -RootDirectory $rootDirectory -InputContents $inputContents -VSDropsPrefix $vsdropsChangeDetectionPrefix
    } catch {
      $converted = $inputContents + "`n`nUnable to convert markdown: $_`n`n"
    }
    $githubComments = New-GitHubCommentsObject -Org "xamarin" -Repo "xamarin-macios" -Token $Env:GITHUB_TOKEN -Hash $Env:GIT_HASH
    $result = $githubComments.NewCommentFromMessage("", "", $converted)
  displayName: 'Publish GitHub comment for change detection'
  timeoutInMinutes: 10
  continueOnError: true # don't let any failures here stop us
  condition: always() # We always want to post something on github
  env:
    GITHUB_TOKEN: $(GitHub.Token)
